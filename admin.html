<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Canteen Preorder</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            text-align: center;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
            margin: 10px 0;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .orders-table-container {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 15px 20px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f8f9fa;
            color: #333;
            font-weight: 600;
        }

        .action-select {
            padding: 5px 10px;
            border-radius: 20px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
        }
    </style>
</head>

<body>

    <nav class="navbar animate-fade-in">
        <div class="brand">Canteen Admin</div>
        <div class="nav-links">
            <a href="#" class="active">Dashboard</a>
            <a href="#" onclick="clearOrders()" style="color: #e74c3c;">Clear Data</a>
            <a href="#" onclick="App.logout()">Logout</a>
        </div>
    </nav>

    <div class="container animate-fade-in" style="max-width: 1200px; margin: 0 auto; padding: 0 20px;">

        <!-- Stats -->
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-label">Total Revenue</div>
                <div class="stat-value" id="total-revenue">₹0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Orders</div>
                <div class="stat-value" id="total-orders">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Pending Orders</div>
                <div class="stat-value" id="pending-orders" style="color: #e67e22;">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Completed</div>
                <div class="stat-value" id="completed-orders" style="color: #2ecc71;">0</div>
            </div>
        </div>

        <h3 class="mb-4">Recent Orders</h3>

        <div class="orders-table-container">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>User</th>
                        <th>Items</th>
                        <th>Total</th>
                        <th>Slot</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="orders-body">
                    <!-- Rows injected -->
                </tbody>
            </table>
        </div>

    </div>

    <script src="app.js"></script>
    <script>
        App.requireAuth("admin");

        function renderDashboard() {
            let orders = JSON.parse(localStorage.orders || "[]").reverse();

            // Stats Calculation
            const totalRevenue = orders.reduce((sum, o) => sum + (o.status !== "Pending Payment" ? o.total : 0), 0);
            const totalOrders = orders.length;
            const pending = orders.filter(o => o.status === "Paid" || o.status === "Preparing").length;
            const completed = orders.filter(o => o.status === "Completed" || o.status === "Ready").length;

            document.getElementById("total-revenue").innerText = `₹${totalRevenue}`;
            document.getElementById("total-orders").innerText = totalOrders;
            document.getElementById("pending-orders").innerText = pending;
            document.getElementById("completed-orders").innerText = completed;

            // Table Render
            const tbody = document.getElementById("orders-body");
            tbody.innerHTML = "";

            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">No orders yet.</td></tr>';
                return;
            }

            orders.forEach(o => {
                const itemsStr = o.items.map(i => i.name).join(", ");

                tbody.innerHTML += `
                    <tr>
                        <td><strong>${o.id.slice(-6)}</strong></td>
                        <td>${o.user}</td>
                        <td style="max-width: 250px; color: #555;">${itemsStr}</td>
                        <td style="font-weight: bold;">₹${o.total}</td>
                        <td>${o.slot}</td>
                        <td><span class="badge status-${o.status.replace(' ', '-')}">${o.status}</span></td>
                        <td>
                            <select class="action-select" onchange="updateStatus('${o.id}', this.value)">
                                <option value="" disabled selected>Update Status</option>
                                <option value="Preparing">Preparing</option>
                                <option value="Ready">Ready</option>
                                <option value="Completed">Completed</option>
                            </select>
                        </td>
                    </tr>
                `;
            });
        }

        function updateStatus(id, newStatus) {
            let orders = JSON.parse(localStorage.orders || "[]");
            let order = orders.find(o => o.id === id);
            if (order) {
                order.status = newStatus;
                localStorage.orders = JSON.stringify(orders);
                renderDashboard();
            }
        }

        function clearOrders() {
            if (confirm("Are you sure? This will wipe all data!")) {
                localStorage.removeItem("orders");
                renderDashboard();
            }
        }

        renderDashboard();
        setInterval(renderDashboard, 5000);

    </script>
</body>

</html>